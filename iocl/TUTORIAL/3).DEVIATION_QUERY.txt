#1>. HTP_TEST DATA ANALYSIS

select count(*) from HTP_TEST;
select COUNT(*) from HTP_TEST WHERE CNT=0;
select COUNT(*) from HTP_TEST WHERE CNT=22222;
select COUNT(*) from HTP_TEST WHERE CNT=11111;
select  * from HTP_TEST WHERE CNT=0;

#2>. JOIN QUERY OF DEVIATION AND STOP



SELECT  IS_CHECKED, IRD_VEH_ID, IAC_IID_ROUTE_ID, IAC_IID_VEHICLE_NO, IAC_IID_SUPPLY_PLANT_CODE, IRD_TRIP_ID,IAC_IID_INVOICE_DATE, IAC_IID_TRIP_ACTUAL_START_TIME, IAC_IID_TRIP_ACTUAL_END_TIME, IRD_DEV_START_AT, IRD_DEV_END_AT,    IAC_TMP_IDLE_START_TIME, IAC_TMP_IDLE_END_TIME, IAC_TMP_TOTAL_STOPPAGE

FROM    iocl.IOCL_ROUTE_DEVIATIONS_NEW D
        JOIN iocl.IOCL_ALLIDLE_CLOSEDTRIPS I ON D.IRD_TRIP_ID = I.IAC_IID_SUPPLY_PLANT_CODE  

WHERE
          D.IRD_DEV_DUR_IN_MINS >= 5
      AND TIMESTAMPDIFF(SECOND, I.IAC_TMP_IDLE_START_TIME, I.IAC_TMP_IDLE_END_TIME)/60 >= 5
    AND D.IRD_IS_DONE = 0
      AND D.IRD_DEV_END_AT >= DATE_ADD(CURDATE(), INTERVAL -14 DAY)
      AND I.IAC_IID_TRIP_ACTUAL_END_TIME >= DATE_ADD(CURDATE(), INTERVAL -14 DAY)
  
      AND I.IAC_TMP_IDLE_START_TIME >= D.IRD_DEV_START_AT
--      AND I.IAC_TMP_IDLE_START_TIME <= D.IRD_DEV_END_AT
--      AND I.IAC_TMP_IDLE_END_TIME >= D.IRD_DEV_START_AT
      AND I.IAC_TMP_IDLE_END_TIME <= D.IRD_DEV_END_AT


#3>. GET DEVIATION AND STOPPAGE DATA

SELECT
  *
 FROM iocl.IOCL_ROUTE_DEVIATIONS_NEW
WHERE IRD_DEV_DUR_IN_MINS>=5
AND IRD_IS_DONE =0 AND IRD_DEV_END_AT >= DATE_ADD(CURDATE(), INTERVAL -1 DAY)  AND IRD_DEV_END_AT >= DATE_ADD(CURDATE(), INTERVAL -0 DAY) ORDER BY IRD_ID DESC;

select count(*) from HTP_TEST;

SELECT * FROM iocl.IOCL_ALLIDLE_CLOSEDTRIPS 
WHERE IAC_IID_TRIP_ACTUAL_END_TIME >= DATE_ADD(CURDATE(), INTERVAL -14 DAY) 
AND TIMESTAMPDIFF(SECOND,IAC_TMP_IDLE_START_TIME,IAC_TMP_IDLE_END_TIME)/60>=5;


#4>. GET DEVIATION AND STOPPAGE DATA DAY WISE DATA


SELECT
  DATE(IRD_DEV_END_AT), COUNT(*) 
 
FROM iocl.IOCL_ROUTE_DEVIATIONS_NEW
WHERE IRD_DEV_DUR_IN_MINS>=5
AND IRD_IS_DONE =0 AND IRD_DEV_END_AT >= DATE_ADD(CURDATE(), INTERVAL -14 DAY) GROUP BY DATE(IRD_DEV_END_AT)  ORDER BY IRD_DEV_END_AT DESC;

SELECT DATE(IAC_IID_TRIP_ACTUAL_END_TIME), COUNT(*)  FROM iocl.IOCL_ALLIDLE_CLOSEDTRIPS 
WHERE IAC_IID_TRIP_ACTUAL_END_TIME >= DATE_ADD(CURDATE(), INTERVAL -14 DAY) 
AND TIMESTAMPDIFF(SECOND,IAC_TMP_IDLE_START_TIME,IAC_TMP_IDLE_END_TIME)/60>=5
GROUP BY DATE(IAC_IID_TRIP_ACTUAL_END_TIME)  ORDER BY IAC_IID_TRIP_ACTUAL_END_TIME DESC;

#5>.

SELECT DISTINCT ID.IID_TRIP_ID,
ID.IID_MATERIAL_CODE,
ID.IID_QUANTITY,
ID.IID_FUEL_UNIT,
ID.IID_PARTY_CODE,
ID.IID_PARTY_NAME,
ID.IID_VEHICLE_NO,
ID.IID_INVOICE_DATE,
ID.IID_SUPPLY_PLANT_CODE,
ID.IID_SUPPLY_PLANT,
ID.IID_SALESAREA_CODE,
ID.IID_DELIVERY_TYPE,
ID.IID_TRIP_STATUS,
ID.IID_TRIP_ACTUAL_START_TIME,
ID.IID_TRIP_ACTUAL_END_TIME,
ID.IID_TRIP_FORCE_CLOSED_TIME,
ID.IID_TRIP_DISTANCE,
ID.IID_VEHICLE_ID,
ID.IID_ROUTE_ID,
(CASE WHEN ID.IID_TRIP_ACTUAL_START_TIME IS NULL THEN ID.IID_INVOICE_DATE
      ELSE ID.IID_TRIP_ACTUAL_START_TIME
 END
)FROM_TIME,
(CASE WHEN ID.IID_TRIP_STATUS=2 THEN ID.IID_TRIP_ACTUAL_END_TIME 
      WHEN ID.IID_TRIP_STATUS IN (3,4) THEN ID.IID_TRIP_FORCE_CLOSED_TIME 
END
)TO_TIME,(SELECT (CASE WHEN UPPER(EDM_DEVICE_NO) LIKE 'E%' THEN 'EFK' ELSE 'QCQ' END)  DEV_TYPE FROM ETRK_DEVICE_MST WHERE EDM_DEVICE_ID IN (SELECT EVM_DEVICE_ID FROM ETRK_VEHICLE_MST WHERE EVM_VEHICLE_ID=iid_vehicle_id))

FROM IOCL_INVOICE_DATA ID JOIN IOCL_ROUTE_DEVIATIONS_NEW DN 
 ON ID.IID_SUPPLY_PLANT_CODE = DN.IRD_TRIP_ID WHERE IRD_DEV_DUR_IN_MINS>=5
-- AND ID.IID_TRIP_ID IN (1898633, 1901429, 1901372, 1901024, 1900006, 1900007, 1899191, 1899143, 1899038, 1899039, 1898865, 1898866, 1898756, 1897917, 1897918, 1974170)
--  AND ID.IID_SUPPLY_PLANT_CODE IN 
AND DN.IRD_IS_DONE =0 AND DN.IRD_DEV_END_AT >= DATE_ADD(CURDATE(), INTERVAL -15 DAY)

AND UPPER(ID.IID_IS_SCHDLR_CALLED)='YES' AND ID.IID_IS_RD_PROCESSED=2 AND ID.IID_VEHICLE_ID is NOT NULL
ORDER BY ID.iid_created_at DESC, IID_SUPPLY_PLANT_CODE;




#6>.

CALL IOCL_PROC_EXCEPTIONS_SCHEDULER_NEW_T_RECOVERY();

SELECT * FROM IOCL_EXCEPTIONS_SCHEDULER_NEW WHERE IESN_CATEGORY ='ROUTE DEVIATION' ORDER BY IESN_IID_INVOICE_DATE DESC;

